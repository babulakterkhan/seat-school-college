<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Exam Management Tool - Ultimate v18</title>
    <style>
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #2c3e50; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 99999; color: white;
        }
        .lock-box { background: #fff; padding: 30px; border-radius: 10px; text-align: center; color: #333; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .lock-box input { padding: 10px; width: 200px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; text-align: center; font-size: 16px; }
        .lock-box button { padding: 10px 25px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }

        body { font-family: 'SolaimanLipi', Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; }
        .tab-bar { background: #2c3e50; padding: 12px; text-align: center; position: sticky; top: 0; z-index: 10000; display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 20px; font-size: 14px; font-weight: bold; cursor: pointer; border: none; background: #34495e; color: white; border-radius: 5px; }
        .tab-btn.active { background: #28a745; }
        
        .section { display: none; padding: 20px; }
        .section.active { display: block; }

        .control-box { background: #fff; padding: 20px; border-radius: 8px; max-width: 1000px; margin: 0 auto 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-top: 4px solid #28a745; }
        .box-title { font-weight: bold; font-size: 18px; margin-bottom: 15px; display: block; color: #2c3e50; }
        
        .input-field { padding: 8px; border: 1px solid #ccc; border-radius: 5px; margin: 5px; font-size: 14px; }
        .full-textarea { width: 95%; height: 50px; padding: 8px; border: 1px solid #ccc; border-radius: 5px; resize: none; margin-bottom: 10px; font-family: inherit; font-size: 13px; }
        
        .btn-container { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; color: #fff; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.3s; }
        
        .btn-blue { background: #007bff; }
        .btn-purple { background: #6f42c1; }
        .btn-orange { background: #fd7e14; }
        .btn-red { background: #dc3545; }
        .btn-green { background: #28a745; }
        .btn-yellow { background: #ffa500; }
        .btn-dark { background: #1a252f; }

        .del-btn { background: #ff4d4d; color: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; font-weight: bold; margin-left: 5px; }
        .del-btn:hover { background: #cc0000; }

        .container { width: 100%; max-width: 1050px; margin: 0 auto; background: white; padding: 30px; border: 1px solid #000; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #000; padding: 5px; text-align: center; position: relative; }
        
        .total-row { font-weight: bold; background-color: #f8f9fa; }
        .table-in { width: 98%; border: none; text-align: center; outline: none; background: transparent; font-size: 14px; font-family: inherit; }

        .header-info-row { display: flex; justify-content: space-between; margin: 10px 0; font-weight: bold; font-size: 16px; border-bottom: 1px solid #000; padding-bottom: 5px; }

        .seat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 190mm; margin: 15px auto; }
        .seat-card { height: 52mm; border: 2px solid #000; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; text-align: center; }
        .inner-border { margin: 4px; border: 1px solid #000; height: 92%; display: flex; flex-direction: column; justify-content: center; }

        @media print {
            .tab-bar, .control-box, .no-print, #lock-screen, .del-btn { display: none !important; }
            .section { display: none; }
            .section.active { display: block; padding: 0; }
            .container { border: none; padding: 0; }
            @page { margin: 10mm; size: A4; }
        }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="lock-box">
        <h3>Exam Tool - লগইন</h3>
        <input type="password" id="passInput" placeholder="পাসওয়ার্ড লিখুন..." onkeypress="if(event.key==='Enter') verifyPass()">
        <br><br>
        <button onclick="verifyPass()">প্রবেশ করুন</button>
        <p id="error-msg" style="color:red; display:none; margin-top:10px;">ভুল পাসওয়ার্ড!</p>
    </div>
</div>

<div id="main-content" style="display:none;">
    <div class="tab-bar no-print">
        <button class="tab-btn active" onclick="openTab('seat-tab', this)">Seat Plan</button>
        <button class="tab-btn" onclick="openTab('roster-tab', this)">Duty Roster</button>
        <button class="tab-btn" onclick="openTab('reg-tab', this)">Answer Register</button>
        <button class="tab-btn" style="background:#555" onclick="changePass()">Change Password</button>
        <button class="tab-btn btn-red" onclick="logout()">Logout</button>
    </div>

    <div id="seat-tab" class="section active">
        <div class="control-box no-print">
            <span class="box-title">Seat Plan Settings:</span>
            <div>
                প্রতিষ্ঠানের নাম: <input type="text" id="sInst" class="input-field" style="width:300px;" oninput="saveData()">
                পরীক্ষা: <input type="text" id="sExam" class="input-field" style="width:150px;" oninput="saveData()">
                তারিখ: <input type="text" id="sDate" class="input-field" style="width:120px;" oninput="saveData()"><br>
                বিষয়: <input type="text" id="sSub" class="input-field" style="width:200px;" oninput="saveData()">
                Class: <input type="text" id="sClass" class="input-field" style="width:80px;" oninput="saveData()">
                Section: <input type="text" id="sSec" class="input-field" style="width:80px;" oninput="saveData()">
                Group: <input type="text" id="sGrp" class="input-field" style="width:100px;" oninput="saveData()"><br>
                Roll: <input type="number" id="sStart" class="input-field" style="width:60px;" value="1" oninput="saveData()"> to <input type="number" id="sEnd" class="input-field" style="width:60px;" value="10" oninput="saveData()">
            </div>
            <div class="btn-container">
                <button class="btn btn-blue" onclick="window.print()">Print Now</button>
                <button class="btn btn-purple" onclick="exportJSON()">Master Backup</button>
                <button class="btn btn-orange" onclick="document.getElementById('upFile').click()">Restore JSON</button>
                <button class="btn btn-red" onclick="clearData()">Clear Everything</button>
            </div>
        </div>
        <div id="seat-container" class="seat-grid"></div>
    </div>

    <div id="roster-tab" class="section">
        <div class="control-box no-print">
            <span class="box-title">রোস্টার কনফিগারেশন</span>
            বিষয়: <input type="text" id="rSub" class="input-field" style="width:200px;" oninput="saveData()">
            তারিখ: <input type="text" id="rDate" class="input-field" style="width:150px;" oninput="saveData()">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <div style="flex:1;">शिक्षক তালিকা: <textarea id="rStaff" class="full-textarea" oninput="updateAllSelects(); saveData()">শিক্ষক ১, শিক্ষক ২</textarea></div>
                <div style="flex:1;">পদবী তালিকা: <textarea id="rDesig" class="full-textarea" oninput="updateAllSelects(); saveData()">প্রভাষক, সহকারী শিক্ষক</textarea></div>
                <div style="flex:1;">প্রতিষ্ঠান তালিকা: <textarea id="rInstList" class="full-textarea" oninput="updateAllSelects(); saveData()">নিজ প্রতিষ্ঠান</textarea></div>
            </div>
            <div class="btn-container">
                <button class="btn btn-blue" onclick="addRow('roster')">+ নতুন সারি</button>
                <button class="btn btn-yellow" onclick="smartMerge('rBody')">স্মার্ট মার্জ</button>
                <button class="btn btn-green" onclick="window.print()">প্রিন্ট করুন</button>
            </div>
        </div>
        <div class="container">
            <div style="text-align:center;">
                <h2 class="display-inst">প্রতিষ্ঠানের নাম</h2>
                <h3 class="display-exam">পরীক্ষার নাম</h3>
                <div class="header-info-row">
                    <span>বিষয়: <span id="rSubView">...</span></span>
                    <span>তারিখ: <span id="rDateView">...</span></span>
                </div>
                <p style="font-weight:bold; text-decoration:underline;">শিক্ষক/পরিদর্শকদের ডিউটি রোস্টার</p>
            </div>
            <table>
                <thead><tr><th width="8%">কক্ষ</th><th width="25%">শিক্ষক</th><th width="20%">পদবী</th><th width="22%">প্রতিষ্ঠানের নাম</th><th width="25%">স্বাক্ষর</th></tr></thead>
                <tbody id="rBody"></tbody>
            </table>
        </div>
    </div>

    <div id="reg-tab" class="section">
        <div class="control-box no-print">
            <span class="box-title">রেজিস্টার কন্ট্রোল প্যানেল</span>
            বিষয়: <input type="text" id="regSub" class="input-field" style="width:200px;" oninput="saveData()">
            তারিখ: <input type="text" id="regDate" class="input-field" style="width:150px;" oninput="saveData()">
            <div class="btn-container">
                <button class="btn btn-blue" onclick="addRow('reg')">+ নতুন সারি</button>
                <button class="btn btn-yellow" onclick="smartMerge('regBody')">স্মার্ট মার্জ</button>
                <button class="btn btn-green" onclick="window.print()">প্রিন্ট করুন</button>
            </div>
        </div>
        <div class="container">
            <div style="text-align:center;">
                <h2 class="display-inst">প্রতিষ্ঠানের নাম</h2>
                <h3 class="display-exam">পরীক্ষার নাম</h3>
                <div class="header-info-row">
                    <span>বিষয়: <span id="regSubView">...</span></span>
                    <span>তারিখ: <span id="regDateView">...</span></span>
                </div>
                <p style="font-weight:bold; text-decoration:underline;">উত্তরপত্র বিতরণ ও সংগ্রহ রেজিস্টার</p>
            </div>
            <table>
                <thead><tr><th width="10%">কক্ষ</th><th width="30%">পরীক্ষক</th><th width="10%">প্রদানকৃত</th><th width="10%">ব্যবহৃত</th><th width="10%">ফেরত</th><th width="30%">স্বাক্ষর</th></tr></thead>
                <tbody id="regBody"></tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="2">সর্বমোট:</td>
                        <td id="totalG"></td>
                        <td id="totalU"></td>
                        <td id="totalF"></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<input type="file" id="upFile" style="display:none" onchange="importJSON(event)">

<script>
    let masterPass = localStorage.getItem('master_password') || "12345678";

    function verifyPass() {
        const input = document.getElementById('passInput').value;
        if(input === masterPass) {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            sessionStorage.setItem('isExamToolUnlocked', 'true');
        } else { document.getElementById('error-msg').style.display = 'block'; }
    }

    function logout() { sessionStorage.removeItem('isExamToolUnlocked'); location.reload(); }

    function changePass() {
        const old = prompt("বর্তমান পাসওয়ার্ড দিন:");
        if(old === masterPass) {
            const newP = prompt("নতুন পাসওয়ার্ড দিন:");
            if(newP) { localStorage.setItem('master_password', newP); masterPass = newP; alert("সফল!"); }
        } else if(old !== null) { alert("ভুল!"); }
    }

    function openTab(id, btn) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    function syncToRegister() {
        const rosterRows = document.querySelectorAll('#rBody tr');
        const regRows = document.querySelectorAll('#regBody tr');
        rosterRows.forEach((rRow, index) => {
            if(regRows[index]) {
                regRows[index].querySelector('.room-field').value = rRow.querySelector('.room-field').value;
                regRows[index].querySelector('.staff-select').value = rRow.querySelector('.staff-select').value;
            }
        });
        saveData();
    }

    function removeRow(btn) {
        if(confirm("সারিটি ডিলিট করতে চান?")) {
            btn.closest('tr').remove();
            saveData(); calculateTotals();
        }
    }

    function addRow(type, data = null) {
        const body = type === 'roster' ? document.getElementById('rBody') : document.getElementById('regBody');
        const tr = document.createElement('tr');
        if(type === 'roster') {
            tr.innerHTML = `<td><input type="text" class="table-in room-field" value="${data?data.r:''}" oninput="syncToRegister()"></td>
                            <td><select class="table-in staff-select" onchange="syncToRegister()">${getOpts('rStaff', data?data.s:'')}</select></td>
                            <td><select class="table-in desig-select">${getOpts('rDesig', data?data.d:'')}</select></td>
                            <td><select class="table-in inst-select">${getOpts('rInstList', data?data.i:'')}</select></td>
                            <td><button class="del-btn no-print" onclick="removeRow(this)">X</button></td>`;
        } else {
            tr.innerHTML = `<td><input type="text" class="table-in room-field" value="${data?data.r:''}" oninput="saveData()"></td>
                            <td><select class="table-in staff-select" onchange="saveData()">${getOpts('rStaff', data?data.s:'')}</select></td>
                            <td><input type="number" class="table-in g-field" value="${data?data.g:''}" oninput="calc(this)"></td>
                            <td><input type="number" class="table-in u-field" value="${data?data.u:''}" oninput="calc(this)"></td>
                            <td><input type="text" class="table-in f-field" value="${data?data.f:''}" readonly></td>
                            <td><button class="del-btn no-print" onclick="removeRow(this)">X</button></td>`;
        }
        body.appendChild(tr);
        if(type === 'reg') calculateTotals();
    }

    function getOpts(id, sel) {
        let o = '<option value=""></option>';
        let area = document.getElementById(id);
        if(area) area.value.split(',').forEach(t => { let v = t.trim(); if(v) o += `<option value="${v}" ${v===sel?'selected':''}>${v}</option>`; });
        return o;
    }

    function updateAllSelects() {
        document.querySelectorAll('.staff-select').forEach(s => { let sv = s.value; s.innerHTML = getOpts('rStaff', sv); });
        document.querySelectorAll('.desig-select').forEach(d => { let dv = d.value; d.innerHTML = getOpts('rDesig', dv); });
        document.querySelectorAll('.inst-select').forEach(i => { let iv = i.value; i.innerHTML = getOpts('rInstList', iv); });
    }

    function calc(el) {
        if(el) {
            const row = el.closest('tr');
            row.querySelector('.f-field').value = (row.querySelector('.g-field').value || 0) - (row.querySelector('.u-field').value || 0);
        }
        calculateTotals(); saveData();
    }

    function calculateTotals() {
        let tg = 0, tu = 0, tf = 0, hasData = false;
        document.querySelectorAll('#regBody tr').forEach(tr => {
            let g = parseInt(tr.querySelector('.g-field').value), u = parseInt(tr.querySelector('.u-field').value), f = parseInt(tr.querySelector('.f-field').value);
            if(!isNaN(g) || !isNaN(u)) hasData = true;
            tg += g || 0; tu += u || 0; tf += f || 0;
        });
        document.getElementById('totalG').innerText = hasData ? tg : "";
        document.getElementById('totalU').innerText = hasData ? tu : "";
        document.getElementById('totalF').innerText = hasData ? tf : "";
    }

    function smartMerge(bodyId) {
        const rows = document.getElementById(bodyId).rows;
        for(let r of rows) { r.cells[0].style.display = ''; r.cells[0].rowSpan = 1; }
        for(let i=0; i<rows.length; i++) {
            let val = rows[i].querySelector('.room-field').value; if(!val) continue;
            let span = 1;
            for(let j=i+1; j<rows.length; j++) { if(rows[j].querySelector('.room-field').value === val) { span++; rows[j].cells[0].style.display = 'none'; } else break; }
            if(span > 1) { rows[i].cells[0].rowSpan = span; i += (span-1); }
        }
    }

    function saveData() {
        const data = {
            seat: { inst: document.getElementById('sInst').value, exam: document.getElementById('sExam').value, sub: document.getElementById('sSub').value, date: document.getElementById('sDate').value, cls: document.getElementById('sClass').value, sec: document.getElementById('sSec').value, grp: document.getElementById('sGrp').value, start: document.getElementById('sStart').value, end: document.getElementById('sEnd').value },
            roster: { sub: document.getElementById('rSub').value, date: document.getElementById('rDate').value, staff: document.getElementById('rStaff').value, desig: document.getElementById('rDesig').value, insts: document.getElementById('rInstList').value, rows: [] },
            reg: { sub: document.getElementById('regSub').value, date: document.getElementById('regDate').value, rows: [] }
        };
        document.querySelectorAll('#rBody tr').forEach(tr => data.roster.rows.push({ r: tr.querySelector('.room-field').value, s: tr.querySelector('.staff-select').value, d: tr.querySelector('.desig-select').value, i: tr.querySelector('.inst-select').value }));
        document.querySelectorAll('#regBody tr').forEach(tr => data.reg.rows.push({ r: tr.querySelector('.room-field').value, s: tr.querySelector('.staff-select').value, g: tr.querySelector('.g-field').value, u: tr.querySelector('.u-field').value, f: tr.querySelector('.f-field').value }));
        localStorage.setItem('exam_db_final', JSON.stringify(data));
        updateView(data);
    }

    function updateView(data) {
        document.querySelectorAll('.display-inst').forEach(el => el.innerText = data.seat.inst || "প্রতিষ্ঠানের নাম");
        document.querySelectorAll('.display-exam').forEach(el => el.innerText = data.seat.exam || "পরীক্ষার নাম");
        document.getElementById('rSubView').innerText = data.roster.sub || "...";
        document.getElementById('rDateView').innerText = data.roster.date || "...";
        document.getElementById('regSubView').innerText = data.reg.sub || "...";
        document.getElementById('regDateView').innerText = data.reg.date || "...";
        const cont = document.getElementById('seat-container');
        cont.innerHTML = '';
        const s = data.seat;
        for(let i=parseInt(s.start); i<=parseInt(s.end); i++) {
            let subDateLine = (s.sub.trim() || s.date.trim()) ? `<div style="font-size:12pt;">${[s.sub, s.date].filter(x=>x.trim()).join(' | ')}</div>` : "";
            let classParts = [`Class: ${s.cls}`, `Sec: ${s.sec}`, `Grp: ${s.grp}`].filter(x => !x.endsWith(': '));
            let classLine = classParts.length ? `<div style="font-size:13pt; font-weight:bold;">${classParts.join(' | ')}</div>` : "";
            cont.innerHTML += `<div class="seat-card"><div class="inner-border"><div style="font-size:15pt; font-weight:bold; border-bottom:1px solid #000; margin:0 15px 5px;">${s.inst || 'প্রতিষ্ঠানের নাম'}</div><div style="font-weight:bold; font-size:14pt;">${s.exam || 'পরীক্ষার নাম'}</div>${subDateLine}${classLine}<div style="font-size:26pt; font-weight:bold;">Roll-${i}</div></div></div>`;
        }
    }

    function exportJSON() {
        const str = localStorage.getItem('exam_db_final'); if(!str) return;
        const blob = new Blob([str], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Exam_Backup.json'; a.click();
    }

    function importJSON(e) {
        const reader = new FileReader();
        reader.onload = (event) => { localStorage.setItem('exam_db_final', event.target.result); location.reload(); };
        reader.readAsText(e.target.files[0]);
    }

    function clearData() { if(confirm("সব মুছবেন?")) { localStorage.clear(); location.reload(); } }

    window.onload = () => {
        if(sessionStorage.getItem('isExamToolUnlocked') === 'true') {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
        }
        const stored = JSON.parse(localStorage.getItem('exam_db_final'));
        if(stored) {
            document.getElementById('sInst').value = stored.seat.inst || ''; document.getElementById('sExam').value = stored.seat.exam || '';
            document.getElementById('sSub').value = stored.seat.sub || ''; document.getElementById('sDate').value = stored.seat.date || '';
            document.getElementById('sClass').value = stored.seat.cls || ''; document.getElementById('sSec').value = stored.seat.sec || '';
            document.getElementById('sGrp').value = stored.seat.grp || '';
            document.getElementById('sStart').value = stored.seat.start || '1'; document.getElementById('sEnd').value = stored.seat.end || '10';
            document.getElementById('rSub').value = stored.roster.sub || ''; document.getElementById('rDate').value = stored.roster.date || '';
            document.getElementById('rStaff').value = stored.roster.staff || ''; document.getElementById('rDesig').value = stored.roster.desig || '';
            document.getElementById('rInstList').value = stored.roster.insts || '';
            document.getElementById('regSub').value = stored.reg.sub || ''; document.getElementById('regDate').value = stored.reg.date || '';
            if(stored.roster.rows.length) stored.roster.rows.forEach(r => addRow('roster', r)); else addRow('roster');
            if(stored.reg.rows.length) stored.reg.rows.forEach(r => addRow('reg', r)); else addRow('reg');
            calculateTotals(); updateView(stored);
        } else { addRow('roster'); addRow('reg'); }
    };
</script>
</body>
</html>